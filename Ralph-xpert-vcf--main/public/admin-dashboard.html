<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard Admin | Ralph Xpert</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      background-color: #0D1117;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      color: #E6EDF3;
      line-height: 1.5;
      font-size: 14px;
    }

    /* Header */
    .admin-header {
      background: linear-gradient(135deg, #161B22, #21262D);
      padding: 16px 25px;
      border-bottom: 1px solid #30363D;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 16px;
    }

    .admin-header h1 {
      color: #2FD771;
      font-size: 1.6rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .user-info span {
      color: #C9D1D9;
      font-size: 0.85rem;
    }

    .logout-btn {
      background: linear-gradient(135deg, #e74c3c, #c0392b);
      color: white;
      padding: 8px 16px;
      border: none;
      border-radius: 8px;
      font-size: 0.8rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .logout-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 3px 12px rgba(231, 76, 60, 0.3);
    }

    /* Main Container */
    .main-container {
      padding: 25px;
      max-width: 1200px;
      margin: 0 auto;
    }

    /* Stats Cards */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 35px;
    }

    .stat-card {
      background: linear-gradient(135deg, #161B22, #21262D);
      padding: 20px;
      border-radius: 14px;
      border: 1px solid #30363D;
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
      transition: all 0.3s ease;
    }

    .stat-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
    }

    .stat-card .icon {
      font-size: 2rem;
      margin-bottom: 12px;
      display: block;
    }

    .stat-card h3 {
      color: #2FD771;
      font-size: 1.8rem;
      font-weight: 700;
      margin-bottom: 4px;
    }

    .stat-card p {
      color: #C9D1D9;
      font-size: 0.9rem;
      margin: 0;
    }

    /* Controls */
    .controls {
      background: #161B22;
      padding: 20px;
      border-radius: 14px;
      border: 1px solid #30363D;
      margin-bottom: 25px;
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      align-items: center;
      justify-content: space-between;
    }

    .search-box {
      flex: 1;
      min-width: 200px;
      max-width: 350px;
    }

    .search-box input {
      width: 100%;
      padding: 10px 12px;
      border: 2px solid #30363D;
      border-radius: 8px;
      background: #21262D;
      color: #E6EDF3;
      font-size: 0.9rem;
      transition: all 0.3s ease;
    }

    .search-box input:focus {
      outline: none;
      border-color: #2FD771;
      box-shadow: 0 0 0 3px rgba(47, 215, 113, 0.2);
    }

    .filter-buttons {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .filter-btn {
      padding: 8px 12px;
      border: 2px solid #30363D;
      border-radius: 8px;
      background: #21262D;
      color: #E6EDF3;
      font-size: 0.8rem;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .filter-btn.active,
    .filter-btn:hover {
      background: #2FD771;
      color: #0D1117;
      border-color: #2FD771;
    }

    .export-btn, .vcf-btn {
      background: linear-gradient(135deg, #2FD771, #26C65A);
      color: #0D1117;
      padding: 10px 16px;
      border: none;
      border-radius: 8px;
      font-size: 0.8rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-left: 8px;
    }

    .vcf-btn {
      background: linear-gradient(135deg, #3498db, #2980b9);
      color: white;
    }

    .export-btn:hover, .vcf-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 3px 12px rgba(47, 215, 113, 0.3);
    }

    /* Messages Table */
    .messages-container {
      background: #161B22;
      border-radius: 14px;
      border: 1px solid #30363D;
      overflow: hidden;
    }

    .messages-header {
      background: linear-gradient(135deg, #21262D, #30363D);
      padding: 16px 20px;
      border-bottom: 1px solid #30363D;
    }

    .messages-header h2 {
      color: #2FD771;
      font-size: 1.4rem;
      font-weight: 700;
      margin: 0;
    }

    .messages-list {
      max-height: 500px;
      overflow-y: auto;
    }

    .message-item {
      padding: 16px 20px;
      border-bottom: 1px solid #30363D;
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .message-item:hover {
      background: #21262D;
    }

    .message-item.unread {
      border-left: 3px solid #2FD771;
      background: rgba(47, 215, 113, 0.05);
    }

    .message-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 8px;
      flex-wrap: wrap;
      gap: 8px;
    }

    .message-info h3 {
      color: #2FD771;
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .message-info p {
      color: #C9D1D9;
      font-size: 0.8rem;
      margin: 2px 0;
    }

    .message-meta {
      text-align: right;
      color: #7D8590;
      font-size: 0.75rem;
    }

    .message-content {
      color: #E6EDF3;
      font-size: 0.9rem;
      margin-bottom: 12px;
      line-height: 1.4;
    }

    .message-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .action-btn {
      padding: 6px 12px;
      border: none;
      border-radius: 6px;
      font-size: 0.75rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .btn-read {
      background: #2FD771;
      color: #0D1117;
    }

    .btn-reply {
      background: #3498db;
      color: white;
    }

    .btn-delete {
      background: #e74c3c;
      color: white;
    }

    .action-btn:hover {
      transform: translateY(-1px);
      opacity: 0.9;
    }

    /* Status Badges */
    .status-badge {
      padding: 3px 6px;
      border-radius: 4px;
      font-size: 0.65rem;
      font-weight: 600;
      text-transform: uppercase;
    }

    .status-new {
      background: #2FD771;
      color: #0D1117;
    }

    .status-read {
      background: #7D8590;
      color: white;
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 50px 20px;
      color: #7D8590;
    }

    .empty-state .icon {
      font-size: 3rem;
      margin-bottom: 16px;
      opacity: 0.5;
    }

    /* Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      z-index: 1000;
      backdrop-filter: blur(5px);
    }

    .modal-content {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #161B22;
      border-radius: 14px;
      border: 1px solid #30363D;
      padding: 25px;
      max-width: 500px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .modal-header h3 {
      color: #2FD771;
      font-size: 1.2rem;
      font-weight: 700;
    }

    .close-btn {
      background: none;
      border: none;
      color: #7D8590;
      font-size: 1.3rem;
      cursor: pointer;
      transition: color 0.3s ease;
    }

    .close-btn:hover {
      color: #e74c3c;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .admin-header {
        padding: 12px 16px;
        flex-direction: column;
        align-items: flex-start;
      }

      .main-container {
        padding: 16px;
      }

      .controls {
        flex-direction: column;
        align-items: stretch;
      }

      .search-box {
        max-width: none;
      }

      .message-header {
        flex-direction: column;
        align-items: flex-start;
      }

      .message-meta {
        text-align: left;
      }

      .message-actions {
        justify-content: flex-start;
      }
    }

    /* Navigation par onglets */
    .tabs-navigation {
      display: flex;
      gap: 8px;
      margin-bottom: 25px;
      border-bottom: 1px solid #30363D;
      padding-bottom: 16px;
    }

    .tab-btn {
      background: #21262D;
      color: #C9D1D9;
      border: 2px solid #30363D;
      padding: 10px 16px;
      border-radius: 8px;
      font-size: 0.8rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .tab-btn.active,
    .tab-btn:hover {
      background: #2FD771;
      color: #0D1117;
      border-color: #2FD771;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    /* Statistiques détaillées */
    .stats-details {
      margin-top: 25px;
    }

    .stats-card {
      background: #161B22;
      padding: 20px;
      border-radius: 14px;
      border: 1px solid #30363D;
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
    }

    .stats-card h3 {
      color: #2FD771;
      font-size: 1.3rem;
      margin-bottom: 16px;
      font-weight: 700;
    }

    .stats-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .stat-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 0;
      border-bottom: 1px solid #30363D;
      font-size: 0.9rem;
    }

    .stat-item:last-child {
      border-bottom: none;
    }

    .stat-item span {
      color: #C9D1D9;
    }

    .stat-item strong {
      color: #2FD771;
      font-weight: 700;
    }

    /* Contacts */
    .contacts-controls {
      background: #161B22;
      padding: 20px;
      border-radius: 14px;
      border: 1px solid #30363D;
      margin-bottom: 25px;
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      align-items: center;
      justify-content: space-between;
    }

    .contacts-actions {
      display: flex;
      gap: 10px;
    }

    .danger-btn {
      background: linear-gradient(135deg, #e74c3c, #c0392b);
      color: white;
      padding: 10px 16px;
      border: none;
      border-radius: 8px;
      font-size: 0.8rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .danger-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 3px 12px rgba(231, 76, 60, 0.3);
    }

    .contacts-container {
      background: #161B22;
      border-radius: 14px;
      border: 1px solid #30363D;
      overflow: hidden;
    }

    .contacts-header {
      background: linear-gradient(135deg, #21262D, #30363D);
      padding: 16px 20px;
      border-bottom: 1px solid #30363D;
    }

    .contacts-header h2 {
      color: #2FD771;
      font-size: 1.4rem;
      font-weight: 700;
      margin: 0;
    }

    .contacts-list {
      max-height: 500px;
      overflow-y: auto;
    }

    .contact-item-admin {
      padding: 16px 20px;
      border-bottom: 1px solid #30363D;
      transition: all 0.3s ease;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .contact-item-admin:hover {
      background: #21262D;
    }

    .contact-info-admin {
      flex: 1;
    }

    .contact-info-admin h3 {
      color: #2FD771;
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .contact-info-admin p {
      color: #C9D1D9;
      font-size: 0.8rem;
      margin: 2px 0;
    }

    .contact-actions-admin {
      display: flex;
      gap: 8px;
    }

    .contact-actions-admin .action-btn {
      padding: 6px 10px;
      font-size: 0.7rem;
    }

    /* Responsive pour les onglets */
    @media (max-width: 768px) {
      .tabs-navigation {
        flex-wrap: wrap;
      }
      
      .tab-btn {
        flex: 1;
        min-width: 120px;
      }
      
      .contacts-controls {
        flex-direction: column;
        align-items: stretch;
      }
      
      .contacts-actions {
        justify-content: center;
      }
      
      .contact-item-admin {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
      }
      
      .contact-actions-admin {
        align-self: flex-end;
      }
    }
  </style>
</head>
<body>

  <header class="admin-header">
    <h1>🛡️ Dashboard Admin</h1>
    <div class="user-info">
      <span>👤 Connecté: <strong id="currentUser"></strong></span>
      <button class="logout-btn" onclick="logout()">🚪 Déconnexion</button>
    </div>
  </header>

  <main class="main-container">
  
  <!-- Navigation par onglets -->
  <section class="tabs-navigation">
    <button class="tab-btn active" onclick="showTab('stats')">📊 Statistiques</button>
    <button class="tab-btn" onclick="showTab('messages')">📬 Messages</button>
    <button class="tab-btn" onclick="showTab('contacts')">👥 Contacts</button>
  </section>

  <!-- Onglet Statistiques -->
  <div id="statsTab" class="tab-content active">
    <section class="stats-grid">
      <div class="stat-card">
        <span class="icon">📧</span>
        <h3 id="totalMessages">0</h3>
        <p>Messages Total</p>
      </div>
      
      <div class="stat-card">
        <span class="icon">🆕</span>
        <h3 id="newMessages">0</h3>
        <p>Nouveaux Messages</p>
      </div>
      
      <div class="stat-card">
        <span class="icon">✅</span>
        <h3 id="readMessages">0</h3>
        <p>Messages Lus</p>
      </div>
      
      <div class="stat-card">
        <span class="icon">👥</span>
        <h3 id="totalContacts">0</h3>
        <p>Contacts Inscrits</p>
      </div>
    </section>

    <section class="stats-details">
      <div class="stats-card">
        <h3>📈 Statistiques Détaillées</h3>
        <div class="stats-list">
          <div class="stat-item">
            <span>📅 Inscriptions aujourd'hui:</span>
            <strong id="todayContacts">0</strong>
          </div>
          <div class="stat-item">
            <span>📩 Messages aujourd'hui:</span>
            <strong id="todayMessages">0</strong>
          </div>
          <div class="stat-item">
            <span>📊 Taux de lecture:</span>
            <strong id="readRate">0%</strong>
          </div>
        </div>
      </div>
    </section>
  </div>

  <!-- Onglet Messages -->
  <div id="messagesTab" class="tab-content">
    <section class="controls">
      <div class="search-box">
        <input type="text" id="searchInput" placeholder="🔍 Rechercher par nom, email ou sujet..." onkeyup="filterMessages()" />
      </div>
      
      <div class="filter-buttons">
        <button class="filter-btn active" onclick="setFilter('all')">Tous</button>
        <button class="filter-btn" onclick="setFilter('unread')">Non lus</button>
        <button class="filter-btn" onclick="setFilter('read')">Lus</button>
        <button class="filter-btn" onclick="setFilter('today')">Aujourd'hui</button>
      </div>
      
      <div>
        <button class="export-btn" onclick="exportMessages()">📊 Exporter CSV</button>
      </div>
    </section>

    <section class="messages-container">
      <div class="messages-header">
        <h2>📬 Messages de Contact</h2>
      </div>
      
      <div class="messages-list" id="messagesList">
        <div class="empty-state">
          <div class="icon">⏳</div>
          <h3>Chargement des messages...</h3>
        </div>
      </div>
    </section>
  </div>

  <!-- Onglet Contacts -->
  <div id="contactsTab" class="tab-content">
    <section class="contacts-controls">
      <div class="search-box">
        <input type="text" id="contactSearchInput" placeholder="🔍 Rechercher un contact..." onkeyup="filterContacts()" />
      </div>
      
      <div class="contacts-actions">
        <button class="vcf-btn" onclick="downloadVCF()">📞 Télécharger VCF</button>
        <button class="danger-btn" onclick="deleteAllContacts()">🗑️ Effacer Tous</button>
      </div>
    </section>

    <section class="contacts-container">
      <div class="contacts-header">
        <h2>👥 Liste des Contacts</h2>
      </div>
      
      <div class="contacts-list" id="contactsList">
        <div class="empty-state">
          <div class="icon">⏳</div>
          <h3>Chargement des contacts...</h3>
        </div>
      </div>
    </section>
  </div>

</main>

  <!-- Modal pour voir le message complet -->
  <div id="messageModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>📧 Détails du Message</h3>
        <button class="close-btn" onclick="closeModal()">&times;</button>
      </div>
      <div id="modalBody">
        <!-- Contenu du message -->
      </div>
    </div>
  </div>

  <script>
    // Configuration API
    const API_BASE = window.location.origin;
    let currentFilter = 'all';
    let allMessages = [];
    let authToken = '';

    // Vérifier l'authentification
    function checkAuth() {
      authToken = localStorage.getItem('adminToken');
      if (!authToken) {
        window.location.href = 'admin-login.html';
        return false;
      }
      
      // Afficher l'utilisateur connecté
      const user = localStorage.getItem('adminUser') || 'Admin';
      document.getElementById('currentUser').textContent = user;
      
      return true;
    }

    // Headers avec authentification
    function getAuthHeaders() {
      return {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${authToken}`
      };
    }

    // Déconnexion
    function logout() {
      if (confirm('Êtes-vous sûr de vouloir vous déconnecter ?')) {
        localStorage.removeItem('adminToken');
        localStorage.removeItem('adminUser');
        localStorage.removeItem('loginTime');
        window.location.href = 'admin-login.html';
      }
    }

    // Charger les statistiques
    async function loadStats() {
      try {
        const response = await fetch(`${API_BASE}/api/admin/stats`, {
          headers: getAuthHeaders()
        });
        
        if (response.status === 401 || response.status === 403) {
          logout();
          return;
        }
        
        const data = await response.json();
        
        if (data.success) {
          document.getElementById('totalMessages').textContent = data.stats.totalMessages;
          document.getElementById('newMessages').textContent = data.stats.newMessages;
          document.getElementById('readMessages').textContent = data.stats.readMessages;
          document.getElementById('totalContacts').textContent = data.stats.totalContacts;
        }
      } catch (error) {
        console.error('Erreur chargement stats:', error);
      }
    }

    // Charger les messages
    async function loadMessages() {
      try {
        const response = await fetch(`${API_BASE}/api/admin/messages`, {
          headers: getAuthHeaders()
        });
        
        if (response.status === 401 || response.status === 403) {
          logout();
          return;
        }
        
        const data = await response.json();
        
        if (data.success) {
          allMessages = data.messages;
          displayMessages(allMessages);
          loadStats(); // Recharger les stats
        }
      } catch (error) {
        console.error('Erreur chargement messages:', error);
        document.getElementById('messagesList').innerHTML = `
          <div class="empty-state">
            <div class="icon">❌</div>
            <h3>Erreur de chargement</h3>
            <p>Impossible de charger les messages.</p>
          </div>
        `;
      }
    }

    // Afficher les messages
    function displayMessages(messages) {
      const container = document.getElementById('messagesList');
      
      if (messages.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="icon">📭</div>
            <h3>Aucun message trouvé</h3>
            <p>Il n'y a pas de messages correspondant à vos critères.</p>
          </div>
        `;
        return;
      }

      container.innerHTML = messages.map(message => `
        <div class="message-item ${!message.read ? 'unread' : ''}" onclick="viewMessage('${message.id}')">
          <div class="message-header">
            <div class="message-info">
              <h3>${message.nom}</h3>
              <p>📧 ${message.email}</p>
              <p>📞 ${message.telephone || 'Non fourni'}</p>
              <p>📋 ${message.sujet}</p>
            </div>
            <div class="message-meta">
              <span class="status-badge ${message.read ? 'status-read' : 'status-new'}">
                ${message.read ? 'Lu' : 'Nouveau'}
              </span>
              <p>${formatDate(message.timestamp)}</p>
            </div>
          </div>
          
          <div class="message-content">
            ${message.message.length > 120 ? message.message.substring(0, 120) + '...' : message.message}
          </div>
          
          <div class="message-actions">
            <button class="action-btn btn-read" onclick="event.stopPropagation(); toggleRead('${message.id}')">
              ${message.read ? '📖 Marquer non lu' : '✅ Marquer lu'}
            </button>
            <button class="action-btn btn-reply" onclick="event.stopPropagation(); replyToMessage('${message.id}')">
              💬 Répondre
            </button>
            <button class="action-btn btn-delete" onclick="event.stopPropagation(); deleteMessage('${message.id}')">
              🗑️ Supprimer
            </button>
          </div>
        </div>
      `).join('');
    }

    // Formater la date
    function formatDate(timestamp) {
      const date = new Date(timestamp);
      const now = new Date();
      const diffTime = Math.abs(now - date);
      const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
      
      if (diffDays === 1) {
        return `Aujourd'hui à ${date.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' })}`;
      } else if (diffDays === 2) {
        return `Hier à ${date.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' })}`;
      } else {
        return date.toLocaleDateString('fr-FR') + ' à ' + date.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
      }
    }

    // Voir le message complet
    function viewMessage(messageId) {
      const message = allMessages.find(m => m.id === messageId);
      if (!message) return;

      // Marquer comme lu automatiquement
      if (!message.read) {
        toggleRead(messageId, false);
      }

      const modalBody = document.getElementById('modalBody');
      modalBody.innerHTML = `
        <div style="margin-bottom: 16px;">
          <h4 style="color: #2FD771; margin-bottom: 8px; font-size: 1rem;">👤 Informations du contact</h4>
          <p style="font-size: 0.9rem; margin: 4px 0;"><strong>Nom :</strong> ${message.nom}</p>
          <p style="font-size: 0.9rem; margin: 4px 0;"><strong>Email :</strong> <a href="mailto:${message.email}" style="color: #2FD771;">${message.email}</a></p>
          <p style="font-size: 0.9rem; margin: 4px 0;"><strong>Téléphone :</strong> ${message.telephone || 'Non fourni'}</p>
          <p style="font-size: 0.9rem; margin: 4px 0;"><strong>Sujet :</strong> ${message.sujet}</p>
          <p style="font-size: 0.9rem; margin: 4px 0;"><strong>Date :</strong> ${formatDate(message.timestamp)}</p>
        </div>
        
        <div style="margin-bottom: 16px;">
          <h4 style="color: #2FD771; margin-bottom: 8px; font-size: 1rem;">💬 Message</h4>
          <div style="background: #21262D; padding: 12px; border-radius: 8px; border-left: 3px solid #2FD771; font-size: 0.9rem; line-height: 1.4;">
            ${message.message.replace(/\n/g, '<br>')}
          </div>
        </div>
        
        <div style="display: flex; gap: 8px; flex-wrap: wrap;">
          <button class="action-btn btn-reply" onclick="replyToMessage('${message.id}')">💬 Répondre par Email</button>
          <button class="action-btn btn-reply" onclick="replyWhatsApp('${message.telephone}', '${message.nom}')">📱 Répondre WhatsApp</button>
          <button class="action-btn btn-delete" onclick="deleteMessage('${message.id}'); closeModal();">🗑️ Supprimer</button>
        </div>
      `;

      document.getElementById('messageModal').style.display = 'block';
    }

    // Fermer la modal
    function closeModal() {
      document.getElementById('messageModal').style.display = 'none';
    }

    // Marquer comme lu/non lu
    async function toggleRead(messageId, updateDisplay = true) {
      const message = allMessages.find(m => m.id === messageId);
      if (!message) return;

      const newReadStatus = !message.read;

      try {
        const response = await fetch(`${API_BASE}/api/admin/messages/${messageId}`, {
          method: 'PATCH',
          headers: getAuthHeaders(),
          body: JSON.stringify({ read: newReadStatus })
        });

        if (response.ok) {
          message.read = newReadStatus;
          if (updateDisplay) {
            loadMessages();
          }
        }
      } catch (error) {
        console.error('Erreur toggle read:', error);
      }
    }

    // Répondre par email
    function replyToMessage(messageId) {
      const message = allMessages.find(m => m.id === messageId);
      if (!message) return;

      const subject = `Re: ${message.sujet}`;
      const body = `Bonjour ${message.nom},\n\nMerci pour votre message concernant "${message.sujet}".\n\n[Votre réponse ici]\n\nCordialement,\nÉquipe Ralph Xpert`;
      
      const mailtoLink = `mailto:${message.email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
      window.open(mailtoLink);
    }

    // Répondre par WhatsApp
    function replyWhatsApp(phone, name) {
      if (!phone || phone === 'Non fourni') {
        alert('Numéro de téléphone non disponible');
        return;
      }
      
      const message = `Bonjour ${name}, merci pour votre message sur Ralph Xpert. Comment puis-je vous aider ?`;
      const whatsappUrl = `https://wa.me/${phone.replace(/[^0-9]/g, '')}?text=${encodeURIComponent(message)}`;
      window.open(whatsappUrl, '_blank');
    }

    // Supprimer un message
    async function deleteMessage(messageId) {
      if (!confirm('Êtes-vous sûr de vouloir supprimer ce message ?')) return;

      try {
        const response = await fetch(`${API_BASE}/api/admin/messages/${messageId}`, {
          method: 'DELETE',
          headers: getAuthHeaders()
        });

        if (response.ok) {
          loadMessages();
        }
      } catch (error) {
        console.error('Erreur suppression:', error);
      }
    }

    // Télécharger le fichier VCF
    async function downloadVCF() {
      try {
        const response = await fetch(`${API_BASE}/api/admin/download/vcf`, {
          headers: getAuthHeaders()
        });

        if (response.ok) {
          const blob = await response.blob();
          const totalContacts = response.headers.get('X-Total-Contacts') || '0';
          
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.style.display = 'none';
          a.href = url;
          a.download = `ralph_xpert_contacts_${new Date().toISOString().split('T')[0]}.vcf`;
          document.body.appendChild(a);
          a.click();
          window.URL.revokeObjectURL(url);
          document.body.removeChild(a);
          
          alert(`✅ Fichier VCF téléchargé avec succès !\n📞 ${totalContacts} contacts exportés`);
        } else {
          alert('❌ Erreur lors du téléchargement du fichier VCF');
        }
      } catch (error) {
        console.error('Erreur téléchargement VCF:', error);
        alert('❌ Erreur de connexion lors du téléchargement');
      }
    }

    // Filtrer les messages
    function setFilter(filter) {
      currentFilter = filter;
      
      // Mettre à jour les boutons
      document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
      event.target.classList.add('active');
      
      filterMessages();
    }

    function filterMessages() {
      const searchTerm = document.getElementById('searchInput').value.toLowerCase();
      let filteredMessages = [...allMessages];

      // Filtrer par recherche
      if (searchTerm) {
        filteredMessages = filteredMessages.filter(message => 
          message.nom.toLowerCase().includes(searchTerm) ||
          message.email.toLowerCase().includes(searchTerm) ||
          message.sujet.toLowerCase().includes(searchTerm) ||
          message.message.toLowerCase().includes(searchTerm)
        );
      }

      // Filtrer par statut
      switch (currentFilter) {
        case 'unread':
          filteredMessages = filteredMessages.filter(m => !m.read);
          break;
        case 'read':
          filteredMessages = filteredMessages.filter(m => m.read);
          break;
        case 'today':
          const today = new Date();
          today.setHours(0, 0, 0, 0);
          filteredMessages = filteredMessages.filter(m => new Date(m.timestamp) >= today);
          break;
      }

      displayMessages(filteredMessages);
    }

    // Exporter en CSV
    function exportMessages() {
      if (allMessages.length === 0) {
        alert('Aucun message à exporter');
        return;
      }

      const headers = ['Date', 'Nom', 'Email', 'Téléphone', 'Sujet', 'Message', 'Statut'];
      const csvContent = [
        headers.join(','),
        ...allMessages.map(message => [
          new Date(message.timestamp).toLocaleString('fr-FR'),
          `"${message.nom}"`,
          message.email,
          message.telephone || '',
          `"${message.sujet}"`,
          `"${message.message.replace(/"/g, '""')}"`,
          message.read ? 'Lu' : 'Non lu'
        ].join(','))
      ].join('\n');

      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);
      link.setAttribute('href', url);
      link.setAttribute('download', `messages_ralph_xpert_${new Date().toISOString().split('T')[0]}.csv`);
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    // Fermer la modal en cliquant à l'extérieur
    window.onclick = function(event) {
      const modal = document.getElementById('messageModal');
      if (event.target === modal) {
        closeModal();
      }
    }

    // Initialisation
    document.addEventListener('DOMContentLoaded', function() {
      if (checkAuth()) {
        loadMessages();
        
        // Actualiser les données toutes les 30 secondes
        setInterval(loadMessages, 30000);
      }
    });

let allContacts = [];

// Gestion des onglets
function showTab(tabName) {
  // Masquer tous les onglets
  document.querySelectorAll('.tab-content').forEach(tab => {
    tab.classList.remove('active');
  });
  
  // Masquer tous les boutons actifs
  document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.classList.remove('active');
  });
  
  // Afficher l'onglet sélectionné
  document.getElementById(tabName + 'Tab').classList.add('active');
  event.target.classList.add('active');
  
  // Charger les données selon l'onglet
  if (tabName === 'contacts') {
    loadContacts();
  } else if (tabName === 'messages') {
    loadMessages();
  } else if (tabName === 'stats') {
    loadStats();
  }
}

// Charger les contacts
async function loadContacts() {
  try {
    const response = await fetch(`${API_BASE}/api/admin/contacts`, {
      headers: getAuthHeaders()
    });
    
    if (response.status === 401 || response.status === 403) {
      logout();
      return;
    }
    
    const data = await response.json();
    
    if (data.success) {
      allContacts = data.contacts;
      displayContacts(allContacts);
    }
  } catch (error) {
    console.error('Erreur chargement contacts:', error);
    document.getElementById('contactsList').innerHTML = `
      <div class="empty-state">
        <div class="icon">❌</div>
        <h3>Erreur de chargement</h3>
        <p>Impossible de charger les contacts.</p>
      </div>
    `;
  }
}

// Afficher les contacts
function displayContacts(contacts) {
  const container = document.getElementById('contactsList');
  
  if (contacts.length === 0) {
    container.innerHTML = `
      <div class="empty-state">
        <div class="icon">👥</div>
        <h3>Aucun contact trouvé</h3>
        <p>Il n'y a pas encore de contacts inscrits.</p>
      </div>
    `;
    return;
  }

  container.innerHTML = contacts.map(contact => `
    <div class="contact-item-admin">
      <div class="contact-info-admin">
        <h3>${contact.nom}</h3>
        <p>📞 ${contact.numeroComplet}</p>
        <p>📅 ${formatDate(contact.timestamp)}</p>
      </div>
      <div class="contact-actions-admin">
        <button class="action-btn btn-reply" onclick="editContact('${contact.id}')">
          ✏️ Modifier
        </button>
        <button class="action-btn btn-delete" onclick="deleteContact('${contact.id}')">
          🗑️ Supprimer
        </button>
      </div>
    </div>
  `).join('');
}

// Filtrer les contacts
function filterContacts() {
  const searchTerm = document.getElementById('contactSearchInput').value.toLowerCase();
  
  if (!searchTerm) {
    displayContacts(allContacts);
    return;
  }
  
  const filteredContacts = allContacts.filter(contact => 
    contact.nom.toLowerCase().includes(searchTerm) ||
    contact.numeroComplet.includes(searchTerm)
  );
  
  displayContacts(filteredContacts);
}

// Modifier un contact
function editContact(contactId) {
  const contact = allContacts.find(c => c.id === contactId);
  if (!contact) return;
  
  const newName = prompt('Nouveau nom:', contact.nom.replace(' (RXP)', ''));
  if (newName && newName !== contact.nom.replace(' (RXP)', '')) {
    // Simuler la modification
    contact.nom = newName + ' (RXP)';
    displayContacts(allContacts);
    alert('✅ Contact modifié avec succès !');
  }
}

// Supprimer un contact
async function deleteContact(contactId) {
  const contact = allContacts.find(c => c.id === contactId);
  if (!contact) return;
  
  if (!confirm(`Êtes-vous sûr de vouloir supprimer "${contact.nom}" ?`)) return;
  
  try {
    // Simuler la suppression
    allContacts = allContacts.filter(c => c.id !== contactId);
    displayContacts(allContacts);
    loadStats(); // Recharger les stats
    alert('✅ Contact supprimé avec succès !');
  } catch (error) {
    console.error('Erreur suppression contact:', error);
    alert('❌ Erreur lors de la suppression');
  }
}

// Effacer tous les contacts
async function deleteAllContacts() {
  if (!confirm('⚠️ ATTENTION: Êtes-vous sûr de vouloir supprimer TOUS les contacts ?\n\nCette action est irréversible !')) {
    return;
  }
  
  if (!confirm('Confirmez-vous la suppression de tous les contacts ?')) {
    return;
  }
  
  try {
    // Simuler la suppression de tous les contacts
    allContacts = [];
    displayContacts(allContacts);
    loadStats(); // Recharger les stats
    alert('✅ Tous les contacts ont été supprimés !');
  } catch (error) {
    console.error('Erreur suppression tous contacts:', error);
    alert('❌ Erreur lors de la suppression');
  }
}

// Mettre à jour loadStats pour inclure les nouvelles statistiques
async function loadStats() {
  try {
    const response = await fetch(`${API_BASE}/api/admin/stats`, {
      headers: getAuthHeaders()
    });
    
    if (response.status === 401 || response.status === 403) {
      logout();
      return;
    }
    
    const data = await response.json();
    
    if (data.success) {
      document.getElementById('totalMessages').textContent = data.stats.totalMessages;
      document.getElementById('newMessages').textContent = data.stats.newMessages;
      document.getElementById('readMessages').textContent = data.stats.readMessages;
      document.getElementById('totalContacts').textContent = data.stats.totalContacts;
      
      // Nouvelles statistiques
      document.getElementById('todayContacts').textContent = data.stats.todayContacts || 0;
      document.getElementById('todayMessages').textContent = data.stats.todayMessages || 0;
      
      const readRate = data.stats.totalMessages > 0 
        ? Math.round((data.stats.readMessages / data.stats.totalMessages) * 100)
        : 0;
      document.getElementById('readRate').textContent = readRate + '%';
    }
  } catch (error) {
    console.error('Erreur chargement stats:', error);
  }
}
  </script>

</body>
</html>
